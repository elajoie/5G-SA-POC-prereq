---
# tasks file for ocp-prep
- name: Create install_config
  become: true
  tags: install
  block:
    - name: Install json package
      dnf:
        name: jq
        state: latest

    - debug:
        var: vault_token_long
    # go here to get your long lived access toekn https://cloud.redhat.com/openshift/token
    - name: Generate access token with offline token
      uri:
        url: https://sso.redhat.com/auth/realms/redhat-external/protocol/openid-connect/token
        method: POST
        body_format: form-urlencoded
        body:
        - [ grant_type, refresh_token ]
        - [ client_id, cloud-services ]
        - [ refresh_token, "{{ vault_token_long }}" ]
      register: access_tokens

    - debug:
        var: access_tokens

    - name: Generate pull secret from access_token
      uri:
        url: https://api.openshift.com/api/accounts_mgmt/v1/access_token
        method: POST
        headers:
          Content-Type: application/yaml
          Authorization: "Bearer {{ access_tokens.json.access_token }}"
      register: pull_secret

    - name: Create a directory for OCP install
      file:
        path: "~/ocp"
        state: directory
        mode: '0755'

    - name: Generate SSH keys on Bastion
      openssh_keypair:
        path: /root/.ssh/id_rsa
      register: sshkey

    - name: Template a ignition file to bastion install folder
      template:
        src: install-config.yaml.j2
        dest: "{{ ocp_install_path }}install-config.yaml"

    - name: Template a .treeinfo to bastion install folder
      template:
        src: .treeinfo.j2
        dest: "{{ ocp_install_path }}.treeinfo"

- name: Remove install_config
  become: true
  tags: remove
  block:
    - name: Remove treeinfo and install_config
      file:
        path: "{{ items }}"
        state: absent
      with_items:
        - "{{ ocp_install_path }}.treeinfo"
        - "{{ ocp_install_path }}install-config.yaml"